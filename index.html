<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kana Quiz – Quizzing </title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;800&family=Noto+Serif+JP:wght@400;700&family=Kosugi+Maru&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f6f8fc; --text:#1f2a44; --muted:#5b6a88;
    --primary:#2f74d0; --primary-600:#1f5fb8; --ring:#90b7ff;
    --tile:#1f78c1; --good:#3ecf5e; --bad:#f25555;
    --border:#d7e6ff; --card:#fff; --shadow:0 10px 24px rgba(36,51,94,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);
       font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Arial,"Hiragino Kaku Gothic ProN","Meiryo",sans-serif;}
  a{color:#2f74d0}
  .wrap{max-width:1000px;margin:0 auto;padding:28px 20px 96px}
  h1{margin:0 0 8px;text-align:center;color:#2e5fb8;font-size:clamp(28px,4.2vw,48px);font-weight:800}
  .lede{max-width:700px;margin:6px auto 18px;text-align:center;color:var(--muted);font-size:15px}

  .controls{display:flex;justify-content:center;gap:10px;margin:12px 0 18px}
  .select{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
  select{appearance:none;border:2px solid #7aa6e6;border-radius:10px;padding:8px 32px 8px 12px;background:#fff;
         background-image:linear-gradient(45deg,transparent 50%,#7aa6e6 50%),linear-gradient(135deg,#7aa6e6 50%,transparent 50%);
         background-position:calc(100% - 18px) 55%,calc(100% - 13px) 55%;background-size:5px 5px,5px 5px;background-repeat:no-repeat}
  select:focus{outline:none;box-shadow:0 0 0 3px var(--ring)}

  .btn{border:2px solid #7aa6e6;background:#fff;color:#1f5fb8;padding:12px 16px;border-radius:12px;
       font-weight:800;letter-spacing:.2px;cursor:pointer;box-shadow:var(--shadow);transition:.15s transform ease,.15s background ease}
  .btn:hover{transform:translateY(-1px)}
  .btn:focus-visible{outline:none;box-shadow:0 0 0 3px var(--ring)}
  .btn-primary{background:#2f74d0;color:#fff;border-color:#2f74d0}
  .btn-primary[aria-pressed="false"]{background:#fff;color:#1f5fb8;border-color:#7aa6e6}
  .btn-ghost{background:#fff;color:#1f5fb8}
  .btn-lg{padding:14px 18px;border-radius:14px}
  .btn-block{width:100%}
  .action-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin:10px 0}
  .wide-row{margin:10px 0}

  .sections{display:grid;gap:22px;grid-template-columns:repeat(3,1fr)}
  @media (max-width:980px){.sections{grid-template-columns:1fr}}
  .card{background:var(--card);border:2px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow)}
  .card h2{margin:2px 6px 12px;color:#2b62bd;font-size:22px;font-weight:800}
  .tile-grid{display:grid;gap:10px}
  .tile-grid.cols-2{grid-template-columns:1fr 1fr}
  .tile{border:2px solid #7aa6e6;border-radius:12px;background:#fff;color:#1e3e78;
        padding:12px 14px;display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;cursor:pointer}
  .tile[aria-pressed="true"]{background:#2f74d0;border-color:#2f74d0;color:#fff}
  .jp{font-size:20px}.ro{font-size:14px;opacity:.9}

  /* font switches for kana surfaces */
  .font-noto-sans{font-family:"Noto Sans JP",sans-serif}
  .font-noto-serif{font-family:"Noto Serif JP",serif}
  .font-kosugi{font-family:"Kosugi Maru","Noto Sans JP",sans-serif}

  /* ===== QUIZ ===== */
  .hidden{display:none !important}
  .topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:10px 0 16px}
  .topbar .left,.topbar .right{display:flex;gap:10px;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:#e8f0fe;color:#2b62bd;font-weight:700;border:1px solid #cfe1ff}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:14px}
  .cardQ{background:#1f78c1;border-radius:18px;padding:16px 14px 12px;box-shadow:var(--shadow)}
  .cardQ .kana{color:#fff;font-size:36px;font-weight:800;min-height:42px}
  .cardQ input{width:100%;margin-top:10px;border:none;border-radius:10px;padding:10px 12px;font-size:16px;
               box-shadow:inset 0 0 0 3px rgba(255,255,255,.9)}
  .cardQ input:focus{outline:none;box-shadow:inset 0 0 0 3px #fff, 0 0 0 3px var(--ring)}
  .cardQ.correct{background:#3ecf5e}
  .cardQ.correct input{opacity:.55;pointer-events:none;box-shadow:inset 0 0 0 3px rgba(255,255,255,.7)}
  .cardQ.incorrect{background:#f25555}
  .shake{animation:shake .25s linear 1}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-3px)}100%{transform:translateX(0)}}
  .note{text-align:center;color:#7a8baa;font-size:12px;margin-top:14px}
</style>
</head>
<body>
<main class="wrap">

  <!-- ===== PICKER VIEW ===== -->
  <section id="view-picker">
    <h1>Tofugu’s Learn Kana Quiz</h1>
    <p class="lede">
      Pick what to practice, choose a font, then click <b>Start Quiz!</b>
      Guides: <a href="https://www.tofugu.com/japanese/learn-hiragana/" target="_blank" rel="noreferrer">Hiragana</a> ·
      <a href="https://www.tofugu.com/japanese/learn-katakana/" target="_blank" rel="noreferrer">Katakana</a>
    </p>

    <div class="controls">
      <div class="select">
        <label for="fontSel">Choose kana font:</label>
        <select id="fontSel" aria-label="Choose kana font">
          <option value="noto-sans" selected>Noto Sans JP</option>
          <option value="noto-serif">Noto Serif JP</option>
          <option value="kosugi">Kosugi Maru</option>
        </select>
      </div>
    </div>

    <div class="action-row">
      <button id="btnHira" class="btn btn-primary btn-lg" aria-pressed="true">Practice Hiragana</button>
      <button id="btnKata" class="btn btn-primary btn-lg" aria-pressed="false">Practice Katakana</button>
    </div>
    <div class="wide-row">
      <button id="btnAllKana" class="btn btn-ghost btn-block btn-lg" aria-pressed="false">All Kana</button>
    </div>

    <section class="sections kana-surface font-noto-sans" id="sections"></section>

    <div style="display:flex;justify-content:center;margin-top:26px">
      <button id="startBtn" class="btn btn-primary btn-lg">Start Quiz!</button>
    </div>
    <div class="note">Type romaji; tiles turn green when correct, red when wrong.</div>
  </section>

  <!-- ===== QUIZ VIEW ===== -->
  <section id="view-quiz" class="hidden">
    <div class="topbar">
      <div class="left">
        <button id="backBtn" class="btn">← Back</button>
        <span class="pill" id="modePill">Hiragana</span>
        <span class="pill" id="countPill">0/0 correct</span>
      </div>
      <div class="right">
        <div class="select">
          <label for="fontSelQ" style="font-size:13px;color:#5b6a88">Font:</label>
          <select id="fontSelQ" aria-label="Choose kana font (quiz)">
            <option value="noto-sans" selected>Noto Sans JP</option>
            <option value="noto-serif">Noto Serif JP</option>
            <option value="kosugi">Kosugi Maru</option>
          </select>
        </div>
        <!-- NEW: Finish Quiz button (appears when all correct) -->
        <button id="finishBtn" class="btn btn-primary hidden">Finish Quiz</button>
      </div>
    </div>

    <section id="quizGrid" class="grid kana-surface font-noto-sans" aria-live="polite"></section>
  </section>

</main>

<script>
/* ===================== DATA ===================== */
const state = { script:"hira", selectedGroups:new Set(), quizItems:[], correctCount:0 };

// Add audio management
const audioCache = new Map();

// Function to preload and cache audio files
function preloadAudio(hiragana) {
  if (!audioCache.has(hiragana)) {
    const audio = new Audio(`Sounds/${hiragana}.mp3`);
    audio.preload = 'auto';
    audioCache.set(hiragana, audio);
  }
}

// Function to play audio for a hiragana character
function playAudio(hiragana) {
  const audio = audioCache.get(hiragana);
  if (audio) {
    audio.currentTime = 0; // Reset to beginning
    audio.play().catch(e => console.log('Audio play failed:', e));
  }
}

// Preload all available audio files
const availableAudio = [
  'あ', 'い', 'う', 'え', 'お',
  'か', 'が', 'き', 'ぎ', 'く', 'ぐ', 'け', 'げ', 'こ', 'ご',
  'さ', 'ざ', 'し', 'じ', 'す', 'ず', 'せ', 'ぜ', 'そ', 'ぞ',
  'た', 'ち', 'つ', 'て', 'と',
  'な', 'に', 'ぬ', 'ね', 'の',
  'は', 'ひ', 'ふ', 'へ', 'ほ',
  'ま', 'み', 'む', 'め', 'も',
  'や', 'ゆ', 'よ',
  'ら', 'り', 'る', 'れ', 'ろ',
  'わ', 'を', 'ん'
];
availableAudio.forEach(preloadAudio);

const ROMAJI_ALTS = {
  shi:["si"], chi:["ti"], tsu:["tu"], fu:["hu"], ji:["zi"],
  di:["ji"], du:["zu"], wo:["o"], ja:["jya","zya"], ju:["jyu","zyu"], jo:["jyo","zyo"]
};
function row(hira,kata,roma){return hira.map((h,i)=>({hira:h,kata:kata[i],roma:roma[i],alts:ROMAJI_ALTS[roma[i]]||[]}));}

const MAIN = {
  a:  row(["あ","い","う","え","お"],["ア","イ","ウ","エ","オ"],["a","i","u","e","o"]),
  ka: row(["か","き","く","け","こ"],["カ","キ","ク","ケ","コ"],["ka","ki","ku","ke","ko"]),
  sa: [{hira:"さ",kata:"サ",roma:"sa",alts:[]},{hira:"し",kata:"シ",roma:"shi",alts:ROMAJI_ALTS.shi},{hira:"す",kata:"ス",roma:"su",alts:[]},{hira:"せ",kata:"セ",roma:"se",alts:[]},{hira:"そ",kata:"ソ",roma:"so",alts:[]}],
  ta: [{hira:"た",kata:"タ",roma:"ta",alts:[]},{hira:"ち",kata:"チ",roma:"chi",alts:ROMAJI_ALTS.chi},{hira:"つ",kata:"ツ",roma:"tsu",alts:ROMAJI_ALTS.tsu},{hira:"て",kata:"テ",roma:"te",alts:[]},{hira:"と",kata:"ト",roma:"to",alts:[]}],
  na: row(["な","に","ぬ","ね","の"],["ナ","ニ","ヌ","ネ","ノ"],["na","ni","nu","ne","no"]),
  ha: [{hira:"は",kata:"ハ",roma:"ha",alts:[]},{hira:"ひ",kata:"ヒ",roma:"hi",alts:[]},{hira:"ふ",kata:"フ",roma:"fu",alts:ROMAJI_ALTS.fu},{hira:"へ",kata:"ヘ",roma:"he",alts:[]},{hira:"ほ",kata:"ホ",roma:"ho",alts:[]}],
  ma: row(["ま","み","む","め","も"],["マ","ミ","ム","メ","モ"],["ma","mi","mu","me","mo"]),
  ya: [{hira:"や",kata:"ヤ",roma:"ya",alts:[]},{hira:"ゆ",kata:"ユ",roma:"yu",alts:[]},{hira:"よ",kata:"ヨ",roma:"yo",alts:[]}],
  ra: row(["ら","り","る","れ","ろ"],["ラ","リ","ル","レ","ロ"],["ra","ri","ru","re","ro"]),
  wa: [{hira:"わ",kata:"ワ",roma:"wa",alts:[]},{hira:"を",kata:"ヲ",roma:"wo",alts:["o"]},{hira:"ん",kata:"ン",roma:"n",alts:["nn","n'"]}]
};
const DAKUTEN = {
  ga: row(["が","ぎ","ぐ","げ","ご"],["ガ","ギ","グ","ゲ","ゴ"],["ga","gi","gu","ge","go"]),
  za: [{hira:"ざ",kata:"ザ",roma:"za",alts:[]},{hira:"じ",kata:"ジ",roma:"ji",alts:["zi"]},{hira:"ず",kata:"ズ",roma:"zu",alts:[]},{hira:"ぜ",kata:"ゼ",roma:"ze",alts:[]},{hira:"ぞ",kata:"ゾ",roma:"zo",alts:[]}],
  da: [{hira:"だ",kata:"ダ",roma:"da",alts:[]},{hira:"ぢ",kata:"ヂ",roma:"ji",alts:["di","ji"]},{hira:"づ",kata:"ヅ",roma:"zu",alts:["du","zu"]},{hira:"で",kata:"デ",roma:"de",alts:[]},{hira:"ど",kata:"ド",roma:"do",alts:[]}],
  ba: row(["ば","び","ぶ","べ","ぼ"],["バ","ビ","ブ","ベ","ボ"],["ba","bi","bu","be","bo"]),
  pa: row(["ぱ","ぴ","ぷ","ぺ","ぽ"],["パ","ピ","プ","ペ","ポ"],["pa","pi","pu","pe","po"])
};
function yCombo(baseH, baseK, lead){const pairs=[["ゃ","ャ","ya"],["ゅ","ュ","yu"],["ょ","ョ","yo"]];return pairs.map(([hS,kS,tail])=>({hira:baseH+hS,kata:baseK+kS,roma:lead+tail,alts:[]}));}
const COMBO = {
  kya: yCombo("き","キ","ky"), sha: yCombo("し","シ","sh"), cha: yCombo("ち","チ","ch"),
  nya: yCombo("に","ニ","ny"), hya: yCombo("ひ","ヒ","hy"), mya: yCombo("み","ミ","my"),
  rya: yCombo("り","リ","ry"), gya: yCombo("ぎ","ギ","gy"),
  ja:  yCombo("じ","ジ","j").map(x=>({...x, alts:["z"+x.roma.slice(1),"jy"+x.roma.slice(2,3)]})),
  dya: yCombo("ぢ","ヂ","dy").map(x=>({...x, alts:[x.roma.replace(/^dy/,"j")]})),
  bya: yCombo("び","ビ","by"), pya: yCombo("ぴ","ピ","py")
};
const PICKER_LABELS = {
  main:[["a","あ/a"],["ka","か/ka"],["sa","さ/sa"],["ta","た/ta"],["na","な/na"],["ha","は/ha"],["ma","ま/ma"],["ya","や/ya"],["ra","ら/ra"],["wa","わ/wa"]],
  dakuten:[["ga","が/ga"],["za","ざ/za"],["da","だ/da"],["ba","ば/ba"],["pa","ぱ/pa"]],
  combo:[["kya","きゃ/kya"],["sha","しゃ/sha"],["cha","ちゃ/cha"],["nya","にゃ/nya"],["hya","ひゃ/hya"],["mya","みゃ/mya"],["rya","りゃ/rya"],["gya","ぎゃ/gya"],["ja","じゃ/ja"],["dya","ぢゃ/dya"],["bya","びゃ/bya"],["pya","ぴゃ/pya"]]
};
const sectionsEl=document.getElementById("sections");

/* ===================== PICKER ===================== */
function renderPicker(){
  sectionsEl.innerHTML="";
  sectionsEl.appendChild(renderCard("Main Kana","all-main",PICKER_LABELS.main,2));
  sectionsEl.appendChild(renderCard("Dakuten Kana","all-dakuten",PICKER_LABELS.dakuten,1));
  sectionsEl.appendChild(renderCard("Combination Kana","all-combo",PICKER_LABELS.combo,2));
  refreshAllButtons();
}
function renderCard(title, allKey, labels, cols){
  const card=document.createElement("section"); card.className="card";
  const h=document.createElement("h2"); h.textContent=title; card.appendChild(h);
  const allBtn=document.createElement("button");
  allBtn.className="btn btn-ghost btn-block";
  allBtn.textContent=title.includes("Main")?"All Main Kana":(title.includes("Dakuten")?"All Dakuten Kana":"All Combination Kana");
  allBtn.onclick=()=>toggleSection(labels.map(([k])=>k));
  card.appendChild(allBtn);
  const grid=document.createElement("div"); grid.className="tile-grid"+(cols===2?" cols-2":"");
  const parts=(cols===2)?[labels.filter((_,i)=>i%2===0),labels.filter((_,i)=>i%2===1)]:[labels];
  parts.forEach(part=>{
    const col=document.createElement("div"); col.style.display="grid"; col.style.gap="10px";
    part.forEach(([key,label])=>{
      const btn=document.createElement("button"); btn.className="tile"; btn.dataset.key=key; btn.setAttribute("aria-pressed", state.selectedGroups.has(key)?"true":"false");
      const [jp,ro]=label.split("/"); btn.innerHTML=`<span class="jp">${jp}</span><span class="ro">/${ro}</span>`;
      btn.onclick=()=>toggleTile(key,btn); col.appendChild(btn);
    }); grid.appendChild(col);
  }); card.appendChild(grid); return card;
}
function toggleTile(key,btn){ if(state.selectedGroups.has(key)){state.selectedGroups.delete(key);btn.setAttribute("aria-pressed","false");} else{state.selectedGroups.add(key);btn.setAttribute("aria-pressed","true");} refreshAllButtons(); }
function toggleSection(keys){ const allSel=keys.every(k=>state.selectedGroups.has(k)); if(allSel) keys.forEach(k=>state.selectedGroups.delete(k)); else keys.forEach(k=>state.selectedGroups.add(k)); renderPicker(); }
function refreshAllButtons(){ const all=[...Object.keys(MAIN),...Object.keys(DAKUTEN),...Object.keys(COMBO)]; document.getElementById("btnAllKana").setAttribute("aria-pressed", all.every(k=>state.selectedGroups.has(k))?"true":"false"); }
renderPicker();

/* ===================== MODE + FONT ===================== */
const btnHira=document.getElementById("btnHira"), btnKata=document.getElementById("btnKata");
btnHira.onclick=()=>{state.script="hira";btnHira.setAttribute("aria-pressed","true");btnKata.setAttribute("aria-pressed","false");updateModePill();}
btnKata.onclick=()=>{state.script="kata";btnKata.setAttribute("aria-pressed","true");btnHira.setAttribute("aria-pressed","false");updateModePill();}
function updateModePill(){ const p=document.getElementById("modePill"); if(p) p.textContent=state.script==="hira"?"Hiragana":"Katakana"; }

const fontSel=document.getElementById("fontSel"), fontSelQ=document.getElementById("fontSelQ");
function applyFont(val){ document.querySelectorAll(".kana-surface").forEach(s=>{s.classList.remove("font-noto-sans","font-noto-serif","font-kosugi"); s.classList.add(val==="noto-serif"?"font-noto-serif":(val==="kosugi"?"font-kosugi":"font-noto-sans"));}); fontSel.value=val; fontSelQ.value=val; }
fontSel.onchange=e=>applyFont(e.target.value); fontSelQ.onchange=e=>applyFont(e.target.value); applyFont(fontSel.value);

/* ===================== QUIZ ===================== */
const viewPicker=document.getElementById("view-picker");
const viewQuiz=document.getElementById("view-quiz");
const quizGrid=document.getElementById("quizGrid");
const countPill=document.getElementById("countPill");
const finishBtn=document.getElementById("finishBtn");

document.getElementById("startBtn").onclick=()=>{
  if(state.selectedGroups.size===0){alert("Select at least one group to practice.");return;}
  // Expand selection → items
  const items=[];
  state.selectedGroups.forEach(key=>{
    if(MAIN[key]) items.push(...MAIN[key]);
    else if(DAKUTEN[key]) items.push(...DAKUTEN[key]);
    else if(COMBO[key]) items.push(...COMBO[key]);
  });
  state.quizItems=shuffle(items.slice()); state.correctCount=0;
  renderQuiz();
  viewPicker.classList.add("hidden"); viewQuiz.classList.remove("hidden");
  updateModePill(); updateCountPill(); updateFinishButton();
  setTimeout(()=>{const f=quizGrid.querySelector("input:not([disabled])"); if(f) f.focus();},50);
};

document.getElementById("backBtn").onclick=()=>endQuiz(false);
finishBtn.onclick=()=>endQuiz(true);

function endQuiz(fromFinish){
  // go back; keep selections; reset quiz area
  viewQuiz.classList.add("hidden");
  viewPicker.classList.remove("hidden");
  quizGrid.innerHTML="";
  state.quizItems=[]; state.correctCount=0;
  updateFinishButton();
  window.scrollTo({top:0,behavior:"smooth"});
  if(fromFinish){ /* could show a toast if you want */ }
}

function renderQuiz(){
  quizGrid.innerHTML="";
  state.quizItems.forEach(it=>{
    const card=document.createElement("div"); card.className="cardQ";
    const kana=document.createElement("div"); kana.className="kana"; kana.textContent = state.script==="hira"?it.hira:it.kata;
    const input=document.createElement("input"); input.type="text"; input.autocapitalize="off"; input.spellcheck=false; input.inputMode="latin";
    input.dataset.ans=it.roma; input.dataset.alts=JSON.stringify(it.alts||[]);
    input.addEventListener("keyup",(ev)=>{ if(ev.key==="Enter"){check(input,card)}});
    input.addEventListener("input",()=>{ card.classList.remove("incorrect","shake"); });
    input.addEventListener("blur",()=>check(input,card));
    card.appendChild(kana); card.appendChild(input); quizGrid.appendChild(card);
  });
}

function updateCountPill(){ countPill.textContent=`${state.correctCount}/${state.quizItems.length} correct`; }
function updateFinishButton(){ if(state.quizItems.length && state.correctCount===state.quizItems.length){ finishBtn.classList.remove("hidden"); finishBtn.focus(); } else { finishBtn.classList.add("hidden"); } }

function normalize(s){return s.trim().toLowerCase();}
function check(input,card){
  if(card.classList.contains("correct")) return;
  const ans=normalize(input.dataset.ans);
  const alts=JSON.parse(input.dataset.alts||"[]").map(normalize);
  const val=normalize(input.value); if(!val) return;
  if(val===ans || alts.includes(val)){
    card.classList.remove("incorrect","shake"); card.classList.add("correct");
    input.value=ans; input.disabled=true; state.correctCount++; updateCountPill(); updateFinishButton();
    
    // Play audio for correct answer
    const kanaElement = card.querySelector('.kana');
    if (kanaElement && state.script === "hira") {
      const hiragana = kanaElement.textContent;
      playAudio(hiragana);
    }
    
    const next=findNextInput(input); if(next) next.focus();
  }else{ card.classList.add("incorrect","shake"); setTimeout(()=>card.classList.remove("shake"),200); }
}
function findNextInput(current){ const inputs=[...quizGrid.querySelectorAll("input")]; const i=inputs.indexOf(current); for(let j=i+1;j<inputs.length;j++){ if(!inputs[j].disabled) return inputs[j]; } return null; }
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
</script>
</body>
</html>
